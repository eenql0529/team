<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout1}">
<head>
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<div layout:fragment="content">

	<th:block layout:fragment="css">

		<link rel="stylesheet" href="/css/cart.css">
		
	</th:block>
	
	
	
	<div class="container_custom">
	
	<div class="right_contents">
			<h2 class="title-page">C A R T<span class="cart_sp"> 장 바 구 니 </span></h2>
			<!--cart process-->
			<div class="page-sorting order font-mss">
				<span class="current-page">장바구니</span>
				<span><i class="ic-14-line-arrow-right"></i></span>
				<span>주문서</span>
				<span><i class="ic-14-line-arrow-right"></i></span>
				<span>주문 완료</span>
			</div>
			<!--//cart process-->
		</div>
	<div class="section_contents">
				
				<table class="table_basic cart_table n-cart-table">
					<colgroup>
						<col width="6%">
						<col width="4%">
						<col width="25%">
						<col width="5%">
						<col width="8%">
						<col width="11%">
						<col width="7%">
						<col width="9%">
					</colgroup>
					<thead>
						<tr>
							<th scope="col">전체<strong>2</strong>개
							</th>
							<th scope="col" style="cursor:pointer"><input type="checkbox" class="chk_all" id="chk_all" th:checked="true" title="전체 상품 선택"></th>
							<th scope="col">상품명</th>
							<th scope="col">판매가</th>
							<th scope="col">할인금액</th>
							<th scope="col">수량</th>
							<th scope="col">주문금액</th>
							<th scope="col">주문관리</th>
						</tr>
					</thead>
					<tbody>
					<th:block th:each="cart , status:${cartList}">	
					<tr class="cart-group">
							<td colspan="9" class="cart_cont">
								<table class="table_basic cart_table">
									<colgroup>
										<col width="6%">
										<col width="4%">
										<col width="25%">
										<col width="5%">
										<col width="8%">
										<col width="11%">
										<col width="7%">
										<col width="9%">
									</colgroup>
									<tbody>
									<tr class="cart_list_no" th:attr="data-cart-status=${cart.itemSellStatus}">
										<td>[[${status.index+1}]]</td>
										<td>
											<input type="checkbox" class="checked_cart" th:value="${cart.cartId}" th:attr="data-cart-id=${cart.cartId}"  th:checked="true"  title="상품 선택">
										</td>
										<td>
											<div class="connect_img">
												<a class="img-block" th:href="'/item/' + ${cart.itemId}">
                                                    <img th:src="${cart.imgUrl}" alt="">
												</a>																																					
											</div>
											<div class="article_info connect_info">
												<p class="list_info ">
													<a href="/app/goods/2545799/0">
														[[${cart.itemNm}]]
													</a>
												</p>
												<p class="txt_option" th:if="${cart.stockNumber >= 5}">
													남은재고 : 5개 이상
												</p>
												<p class="txt_option" th:unless="${cart.stockNumber >= 5}" th:text="'남은재고: ' + ${cart.stockNumber} + '개'">
												</p>
												
											</div>
										</td>
										<td class="td_price">
											<div class="td_price_wrap" id="so_ori_price">
											[[${#numbers.formatInteger(cart.price * cart.count , 0, 'COMMA')}]]
										</div>
										</td>
                                        <td th:if="${cart.sale} != 0" id="so_sale_price">
											[[${#numbers.formatInteger((cart.price * cart.sale / 100) * cart.count , 0, 'COMMA')}]]원
                                            </td>
                                         <td th:if="${cart.sale} == 0"> 
											 <span class="no_sale"> 할인상품 X </span>
                                            </td>
                                            
										<td>
											[[${cart.count}]]	
										</td>
										<td id="so_total_price">
											[[${#numbers.formatInteger((cart.price - (cart.price * cart.sale / 100)) * cart.count , 0, 'COMMA')}]]
										</td>
										<td>
							<button onclick="cartCountUpdate_button(this)" th:attr="data-cart-id=${cart.cartId}" class="plain-btn btn">수량변경</button>
							<button onclick="cartDelete_button(this)" th:attr="data-cart-id=${cart.cartId}" class="plain-btn btn mt-2">삭제하기</button>
										</td>
									</tr>
							</tbody>
								</table>
							</td>
						</tr>
						</th:block>
						
				</tbody>
				</table>
				<div class="delete-btn-area">
					<button id="del_chk" onclick="cartDelete_checkBok()" class="plain-btn btn">선택삭제</button>
				</div>
			
	
	<!--	<span class="goods_qty">
                                                        <span>
                                                            <button type="button" class="down goods_cnt" title="감소" id="down">감소</button>
                                                            <input type="text" id="goodsCnt" name="goodsCnt" class="text goodsCnt_0" title="수량" th:value="${cart.count}" th:attr="data-cart-stock=${cart.stockNumber}">
                                                            <button type="button" class="up goods_cnt" title="증가" id="up">증가</button>
                                                        </span>
                                                    </span>-->
		
		
	</div>
		 <div class="final_box">
					<ul class="final-payment">
					<li>
						<p class="final-payment-ti">상품 금액</p>
						<p class="final-payment-price">
							<input type="hidden" class="cart_normal_price" value="307400">
							<span class="cart_normal_add_opt_price" id="ori_price">[[${#numbers.formatInteger(totalCount , 0, 'COMMA')}]]</span><span class="pay_won">원</span>
						</p>
					</li>
					<li class="final-payment-ic">
						<i class="ic-18-line-plus"></i>
					</li>
					<li>
						<p class="final-payment-ti">배송비</p>
						<p class="final-payment-price">
							<input type="hidden" class="cart_normal_price" value="307400">
							<span class="cart_normal_add_opt_price" id="delevery_price">[[${#numbers.formatInteger(deleveryCount , 0, 'COMMA')}]]</span><span class="pay_won">원</span>
						</p>
					</li>
					<li class="final-payment-ic">
						<i class="ic-18-line-minus"></i>
					</li>
					<li>
						<p class="final-payment-ti">할인 합계</p>
						<input type="hidden" class="cart_total_save" value="40650">
						<p class="final-payment-price"><span class="cart_total_add_opt_save">[[${#numbers.formatInteger(saleCount , 0, 'COMMA')}]]</span><span class="pay_won">원</span></p>
					</li>
					<li class="final-payment-ic">
						<i class="ic-18-line-handle"></i>
					</li>
					<li>
						<p class="final-payment-ti">최종 결제 금액</p>
						<p class="final-payment-price"><span id="pay_amt" class="total_pay">[[${#numbers.formatInteger(finalCount , 0, 'COMMA')}]]</span><span class="pay_won">원</span></p>
						<p class="final-payment-save"><span id="total_dc_rate">13</span>% SAVE</p>
					</li>
				</ul>
				
				
				<div class="n-btn-group n-btn-order">
					<button type="button" class="n-btn btn-lg btn-accent" id="btn-order">주문하기
					</button>
				</div>
		</div>
		
		
			</div>
	
	
</div>


<th:block layout:fragment="script">
	
	<script>
		
		
	$(document).ready(function() {
  // 전체 선택/해제 체크박스 클릭 이벤트
  $('#chk_all').change(function() {
    if($(this).prop('checked')) {
      // 전체 선택
      $('.checked_cart').prop('checked', true);
    } else {
      // 전체 해제
      $('.checked_cart').prop('checked', false);
    }
  });
});
	
$(document).ready(function() {
  
  // 함수 정의: 체크박스 상태 확인 후 버튼 클래스 업데이트
  function updateButtonState() {
    if ($('.checked_cart:checked').length > 0) {
      $('#del_chk').removeClass('click_disable');
    } else {
      $('#del_chk').addClass('click_disable');
    }
  }

  // 페이지 로드 시 초기 버튼 상태 설정
  updateButtonState();

  // 개별 체크박스 상태가 바뀔 때마다 버튼 상태 업데이트
  $('.checked_cart').change(function() {
    updateButtonState();
  });

  // 전체 선택/해제 체크박스 클릭 이벤트
  $('#chk_all').change(function() {
    if($(this).prop('checked')) {
      // 전체 선택
      $('.checked_cart').prop('checked', true);
    } else {
      // 전체 해제
      $('.checked_cart').prop('checked', false);
    }
    updateButtonState();  // 여기서 버튼 상태도 업데이트
  });
});
		
		
		
		
		
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		
		
		function cartDelete_button(button){
			var id = $(button).attr("data-cart-id");
			var url = '/cartDeleteButton'
			paramData = {cartId : id};
			
			if (confirm('장바구니에서 삭제하시겠습니까?')){
				
				var param = JSON.stringify(paramData);
				
					$.ajax({
						url : url, //request URL
						type : "POST", //전송방식
						contentType : "application/json",
						data : param, //서버에 전송할 데이터
						beforeSend : function(xhr) {
							//데이터를 전송하기전에 헤더에 csrf 값을 설정
							xhr.setRequestHeader(header, token);
						},
						dataType : "text",
						cache : false,
						success : function(result, status, jqXHR) {
							 alert(jqXHR.responseText);
							 window.location.reload(true); 
							
						},
						error : function(jqXHR, status, error) {
							if (jqXHR.status == '401') {
								alert('관리자로그인 후 이용해주세요.');
								//	location.href = '/';
							} else {
								//에러메세지 출력(ResponseEntity에서 받아온 값을 출력해준다)
								alert(jqXHR.responseText);
							}
						}
					})
			}
								
		}
		
		function cartDelete_checkBok(){
			
			var selectedItems = [];
			var url = '/cartDeletCkeckBox'
			
			 $('.checked_cart:checked').each(function() {
    				  selectedItems.push($(this).attr('data-cart-id'));
    			});
    			
    		var param = JSON.stringify(selectedItems);
    		
    			if (confirm('선택된 상품 장바구니에서 삭제하시겠습니까?')){
						$.ajax({
						url : url, //request URL
						type : "POST", //전송방식
						contentType : "application/json",
						data : param, //서버에 전송할 데이터
						beforeSend : function(xhr) {
							//데이터를 전송하기전에 헤더에 csrf 값을 설정
							xhr.setRequestHeader(header, token);
						},
						dataType : "text",
						cache : false,
						success : function(result, status, jqXHR) {
							 alert(jqXHR.responseText);
							 window.location.reload(true); 
							
						},
						error : function(jqXHR, status, error) {
							if (jqXHR.status == '401') {
								alert('관리자로그인 후 이용해주세요.');
								//	location.href = '/';
							} else {
								//에러메세지 출력(ResponseEntity에서 받아온 값을 출력해준다)
								alert(jqXHR.responseText);
							}
						}
					})
					
				}
    			
			
		}


		
		
	</script>
	
	<script th:inline="javascript">
	
	</script>
	</th:block>


</html>